# 인덱스?

인덱스는 쉽게 말해서 책의 Index 와 비슷한 역할을 합니다. 우리가 **인덱스를 사용해야 하는 이유는 DB 에서 데이터를 찾기 위해서 직접 디스크에서 읽는 횟수를 줄이기 위해서** 입니다. 즉 인덱스는 아래와 같은 구조를 지닙니다.

![B-Tree 사진]()

즉 해당 사진 처럼, 디스크 파일에 최대한 접근하는 횟수를 줄이기 위함입니다. 사진 처럼 **인덱스는 루트노드, 브랜치노드, 리프노드로 분리되는데 루트노드는 제일 최상위의 노드이고, 리프노드는 제일 최하위의 노드이며, 브랜치노드는 그 중간의 노드**를 말합니다.

그림에서 보면 인덱스는 항상 정렬되어 있는 자료구조임을 알 수 있습니다. 따라서 인덱스를 사용하는데는 다음과 같은 추가 비용이 발생합니다.

- **INSERT, UPDATE, DELETE** 시 추가적인 갱신작업이 일어나므로, B-Tree 에도 정렬작업이 다시 일어나게 됩니다. 따라서 **갱신+정렬**로 추가적인 **정렬 비용**이 발생하게 됩니다.

## 인덱스 정렬

위에서 그림으로 보았듯이 인덱스를 사용하면 즉 자식의 주소를 가르키게 되고, 결국 리프노드에서는 File 의 Low 주소로 이어지게 되어, 조회시에 디스크에 접근하는 횟수를 줄일 수 있게 됩니다.

- 인덱스의 N 번째 컬럼은 N-1 번째 컬럼에 의존해서 정렬되어 있습니다. 이건 정말 중요한 개념인데, 즉 첫번째<->두번째<->세번째는 같은 열에 있는 것들끼리만 의미가 있다는 것이다.

이로 인해 발생할 수 있는 문제의 예시를 한번 보시죠

- 첫번째 케이스 : dept_no, emp_no 로 인덱스를 건 경우입니다. 

이 경우에 우리가 `select * from table where dept_no = 002 AND emp_no >= 10144` 라는 쿼리를 날렸다고 해보자. 잘 명심해 두어야 할 점은 **N-1 번째 컬럼은 N 번째에 의존하여 재 정렬**된다는 말이다. 그니까 emp_no 는 dept_no 에 의해 정렬되었다. 따라서 옵티마이저는 아래와 같은 생각을 한다.

아 저렇게 쿼리가 날라왔으니, **일단 dept_no 가 002고, 10144 보다 같거나 큰 행중 가장 첫번째 컬럼을 찾자!** 라고 말해서 아래 **(d002, 10144) 에 일단은 도착**할 것이다.

그 **이후로는 정렬이 되어있을테니 d002 가 아닐때까지 읽기만 하면된다. 즉 emp_no 가 dept_no 에 의해 정렬되어 있다는 사실을 알기때문에, 이렇게 d002 가 아닐때까지 읽는것이 가능한것**이다.

|dept_no|emp_no|
|:---|:---:|
|d001|10239|
|d001|10259|
|d002|10050|
|d002|10059|
|d002|10132|
|**d002**|**10144**|
|d002|10146|
|d002|10147|
|d002|10165|
|d002|10173|
|d003|10005|

그럼 반대로 반대로 한다면 어떨까?

- 두번째 케이스 : emp_no, dept_no 로 인덱스를 건 경우입니다.

|emp_no|dept_no|
|:---|:---:|
|10005|d003|
|10013|d003|
|10042|d002|
|10050|d002|
|10059|d002|
|10080|d002|
|10132|d002|
|**10144**|**d002**|
|10146|d002|
|10147|d002|
|10165|d002|
|10173|d002|
|10239|d004|
|10259|d004|

이번에는 아래와 같은 쿼리가 실행됩니다.

`select * from table where emp_no >= 10144 AND dept_no = d002` 

이렇게 되면 옵티마이저는 생각합니다. 아일단 emp_no 가 10144 보다 크면서 d002 인지점으로 가자 라고 해서 (10144, d002) 지점에 도달할 겁니다. 그런데 여기서 10144 가 d002 가 맞는 조건을 확인하려면 결국에 10144 보다 큰 것들 중에 d002 인것들을 골라내야 합니다.

왜냐하면 dept_no 가 emp_no 에 의해 재 정렬된것이 아무런 도움도 주지 못하기 때문입니다. 그래서 실제로 쿼리는 10144 ~ 10259 까지 총 7번 작동하게 됩니다. 그리고 그 중에 **d002** 인 것들만 추려서 첫번째 케이스와 같은 5개의 값을 보여줄겁니다.

두번째는 **필터링 효과를 첫번째는 작업 범위 결정 조건**을 타게 된것이죠. 이것이 **우리가  인덱스의 순서를 잘 지정해야 하는 이유**입니다.